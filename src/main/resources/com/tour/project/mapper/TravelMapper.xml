<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.tour.project.dao.TravelDAO">

    <!-- 여행 계획 등록 -->
    <insert id="insertTravel" parameterType="com.tour.project.dto.TravelDTO" useGeneratedKeys="true" keyProperty="travelId">
        INSERT INTO TRAVEL (
            USER_ID, TITLE, DESTINATION, START_DATE, END_DATE,
            DESCRIPTION, MAX_PARTICIPANTS, STATUS
        ) VALUES (
            #{userId}, #{title}, #{destination}, #{startDate}, #{endDate},
            #{description}, #{maxParticipants}, #{status}
        )
    </insert>
    
    <!-- 여행 계획 상세 조회 -->
    <select id="getTravelById" parameterType="long" resultType="com.tour.project.dto.TravelDTO">
        SELECT 
            t.TRAVEL_ID as travelId,
            t.USER_ID as userId,
            t.TITLE as title,
            t.DESTINATION as destination,
            t.START_DATE as startDate,
            t.END_DATE as endDate,
            t.DESCRIPTION as description,
            t.MAX_PARTICIPANTS as maxParticipants,
            t.PARTICIPANT_COUNT as participantCount,
            t.STATUS as status,
            t.CREATED_DATE as createdDate,
            m.USER_NAME as userName
        FROM TRAVEL t
        LEFT JOIN MEMBER m ON t.USER_ID = m.USER_ID
        WHERE t.TRAVEL_ID = #{travelId}
    </select>
    
    <!-- 모든 여행 계획 조회 -->
    <select id="getAllTravels" resultType="com.tour.project.dto.TravelDTO">
        SELECT 
            t.TRAVEL_ID as travelId,
            t.USER_ID as userId,
            t.TITLE as title,
            t.DESTINATION as destination,
            t.START_DATE as startDate,
            t.END_DATE as endDate,
            t.DESCRIPTION as description,
            t.MAX_PARTICIPANTS as maxParticipants,
            t.PARTICIPANT_COUNT as participantCount,
            t.STATUS as status,
            t.CREATED_DATE as createdDate,
            m.USER_NAME as userName
        FROM TRAVEL t
        LEFT JOIN MEMBER m ON t.USER_ID = m.USER_ID
        WHERE t.STATUS = 'ACTIVE'
        ORDER BY t.CREATED_DATE DESC
    </select>
    
    <!-- 사용자별 여행 계획 조회 -->
    <select id="getTravelsByUserId" parameterType="string" resultType="com.tour.project.dto.TravelDTO">
        SELECT 
            t.TRAVEL_ID as travelId,
            t.USER_ID as userId,
            t.TITLE as title,
            t.DESTINATION as destination,
            t.START_DATE as startDate,
            t.END_DATE as endDate,
            t.DESCRIPTION as description,
            t.MAX_PARTICIPANTS as maxParticipants,
            t.PARTICIPANT_COUNT as participantCount,
            t.STATUS as status,
            t.CREATED_DATE as createdDate
        FROM TRAVEL t
        WHERE t.USER_ID = #{userId}
        ORDER BY t.CREATED_DATE DESC
    </select>
    
    <!-- 여행 계획 수정 -->
    <update id="updateTravel" parameterType="com.tour.project.dto.TravelDTO">
        UPDATE TRAVEL SET
            TITLE = #{title},
            DESTINATION = #{destination},
            START_DATE = #{startDate},
            END_DATE = #{endDate},
            DESCRIPTION = #{description},
            MAX_PARTICIPANTS = #{maxParticipants},
            STATUS = #{status}
        WHERE TRAVEL_ID = #{travelId}
    </update>
    
    <!-- 여행 계획 삭제 -->
    <delete id="deleteTravel" parameterType="long">
        DELETE FROM TRAVEL WHERE TRAVEL_ID = #{travelId}
    </delete>
    
    <!-- 여행 참여하기 (travel_plan 테이블과 호환) -->
    <insert id="joinTravel">
        INSERT INTO travel_participants (travel_plan_id, user_id, joined_date, status)
        VALUES (#{travelId}, #{userId}, NOW(), 'ACTIVE')
    </insert>
    
    <!-- 여행 참여 취소 -->
    <delete id="leaveTravel">
        DELETE FROM travel_participants 
        WHERE travel_plan_id = #{travelId} AND user_id = #{userId}
    </delete>
    
    <!-- 사용자 참여 여부 확인 -->
    <select id="isUserJoined" resultType="boolean">
        SELECT COUNT(*) > 0
        FROM travel_participants
        WHERE travel_plan_id = #{travelId} AND user_id = #{userId} AND status = 'ACTIVE'
    </select>
    
    <!-- 여행 참여자 목록 조회 (동행장 포함) -->
    <select id="getParticipantsByTravelId" parameterType="long" resultType="com.tour.project.dto.TravelParticipantDTO">
        SELECT * FROM (
            SELECT
                0 as participantId,
                t.plan_id as travelId,
                t.plan_writer as userId,
                t.plan_regdate as joinedDate,
                'HOST' as status,
                m.user_name as userName,
                m.nickname as nickname,
                1 as sort_order
            FROM travel_plan t
            LEFT JOIN member m ON t.plan_writer = m.user_id
            WHERE t.plan_id = #{travelId}

            UNION ALL

            SELECT
                tp.participant_id as participantId,
                tp.travel_plan_id as travelId,
                tp.user_id as userId,
                tp.joined_date as joinedDate,
                tp.status as status,
                m.user_name as userName,
                m.nickname as nickname,
                2 as sort_order
            FROM travel_participants tp
            LEFT JOIN member m ON tp.user_id = m.user_id
            WHERE tp.travel_plan_id = #{travelId}
                AND tp.status = 'ACTIVE'
                AND tp.user_id NOT IN (
                    SELECT plan_writer FROM travel_plan WHERE plan_id = #{travelId}
                )
        ) AS combined_participants
        ORDER BY sort_order, joinedDate ASC
    </select>
    
    <!-- 사용자가 참여한 여행 목록 조회 (동행장이 만든 여행 + 참여한 여행 모두 포함) -->
    <select id="getJoinedTravelsByUserId" parameterType="string" resultType="com.tour.project.dto.TravelParticipantDTO">
        SELECT * FROM (
            SELECT
                NULL as participantId,
                t.plan_id as travelId,
                t.plan_writer as userId,
                t.plan_regdate as joinedDate,
                'ACTIVE' as status,
                t.plan_title as travelTitle,
                t.plan_destination as destination,
                t.plan_start_date as startDate,
                t.plan_end_date as endDate,
                t.plan_budget as budget,
                t.plan_content as content,
                t.plan_writer as planWriter,
                t.plan_max_people as maxPeople,
                t.plan_regdate as planRegdate,
                m.user_name as planWriterName
            FROM travel_plan t
            LEFT JOIN member m ON t.plan_writer = m.user_id
            WHERE t.plan_writer = #{userId}

            UNION

            SELECT
                tp.participant_id as participantId,
                tp.travel_plan_id as travelId,
                tp.user_id as userId,
                tp.joined_date as joinedDate,
                tp.status as status,
                t.plan_title as travelTitle,
                t.plan_destination as destination,
                t.plan_start_date as startDate,
                t.plan_end_date as endDate,
                t.plan_budget as budget,
                t.plan_content as content,
                t.plan_writer as planWriter,
                t.plan_max_people as maxPeople,
                t.plan_regdate as planRegdate,
                m.user_name as planWriterName
            FROM travel_participants tp
            INNER JOIN travel_plan t ON tp.travel_plan_id = t.plan_id
            LEFT JOIN member m ON t.plan_writer = m.user_id
            WHERE tp.user_id = #{userId} AND (tp.status = 'ACTIVE' OR tp.status = 'APPROVED')
        ) AS all_travels
        ORDER BY joinedDate DESC
    </select>
    
    <!-- 참여중인 여행 조회 (내가 작성하지 않은 여행 중 참여 승인된 것만) -->
    <select id="getParticipatingTravelsByUserId" parameterType="string" resultType="com.tour.project.dto.TravelParticipantDTO">
        SELECT
            tp.participant_id as participantId,
            tp.travel_plan_id as travelId,
            tp.user_id as userId,
            tp.joined_date as joinedDate,
            tp.status as status,
            t.plan_title as travelTitle,
            t.plan_destination as destination,
            t.plan_start_date as startDate,
            t.plan_end_date as endDate,
            t.plan_budget as budget,
            t.plan_content as content,
            t.plan_writer as planWriter,
            t.plan_regdate as planRegdate,
            m.user_name as planWriterName
        FROM travel_participants tp
        INNER JOIN travel_plan t ON tp.travel_plan_id = t.plan_id
        LEFT JOIN member m ON t.plan_writer = m.user_id
        WHERE tp.user_id = #{userId}
            AND t.plan_writer != #{userId}
            AND (tp.status = 'ACTIVE' OR tp.status = 'APPROVED')
        ORDER BY tp.joined_date DESC
    </select>

    <!-- 참여자 수 조회 -->
    <select id="getParticipantCount" parameterType="long" resultType="int">
        SELECT COUNT(*) FROM travel_participants
        WHERE travel_plan_id = #{travelId} AND status = 'ACTIVE'
    </select>
    
    <!-- 참여자 수 업데이트 -->
    <update id="updateParticipantCount">
        UPDATE TRAVEL SET PARTICIPANT_COUNT = #{count}
        WHERE TRAVEL_ID = #{travelId}
    </update>
    
    <!-- 여행 검색 -->
    <select id="searchTravels" parameterType="map" resultType="com.tour.project.dto.TravelDTO">
        SELECT 
            t.TRAVEL_ID as travelId,
            t.USER_ID as userId,
            t.TITLE as title,
            t.DESTINATION as destination,
            t.START_DATE as startDate,
            t.END_DATE as endDate,
            t.DESCRIPTION as description,
            t.MAX_PARTICIPANTS as maxParticipants,
            t.PARTICIPANT_COUNT as participantCount,
            t.STATUS as status,
            t.CREATED_DATE as createdDate,
            m.USER_NAME as userName
        FROM TRAVEL t
        LEFT JOIN MEMBER m ON t.USER_ID = m.USER_ID
        WHERE t.STATUS = 'ACTIVE'
        <if test="destination != null and destination != ''">
            AND t.DESTINATION LIKE CONCAT('%', #{destination}, '%')
        </if>
        <if test="startDate != null">
            AND t.START_DATE &gt;= #{startDate}
        </if>
        <if test="endDate != null">
            AND t.END_DATE &lt;= #{endDate}
        </if>
        ORDER BY t.CREATED_DATE DESC
    </select>

</mapper>