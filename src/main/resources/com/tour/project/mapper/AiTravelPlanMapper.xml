<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.tour.project.dao.AiTravelPlanDAO">

    <!-- AI 여행 계획 저장 -->
    <insert id="insertAiTravelPlan" parameterType="com.tour.project.dto.AiTravelPlanDTO" useGeneratedKeys="true" keyProperty="planId">
        INSERT INTO ai_travel_plans (
            user_id, title, destination, start_date, end_date, duration, budget, max_participants, travel_style,
            plan_content, is_template, created_at, updated_at
        ) VALUES (
            #{userId}, #{title}, #{destination}, #{startDate}, #{endDate}, #{duration}, #{budget}, #{maxParticipants}, #{travelStyle},
            #{planContent}, #{isTemplate}, CURRENT_TIMESTAMP, CURRENT_TIMESTAMP
        )
    </insert>

    <!-- AI 여행 계획 상세 조회 -->
    <select id="getAiTravelPlan" parameterType="Long" resultType="com.tour.project.dto.AiTravelPlanDTO">
        SELECT 
            plan_id as planId,
            user_id as userId,
            title,
            destination,
            start_date as startDate,
            end_date as endDate,
            duration,
            CASE 
                WHEN budget REGEXP '^[0-9]+$' THEN CAST(budget AS DECIMAL(10,2))
                ELSE NULL
            END as budget,
            max_participants as maxParticipants,
            travel_style as travelStyle,
            CASE 
                WHEN JSON_VALID(plan_content) AND JSON_EXTRACT(plan_content, '$.content') IS NOT NULL 
                THEN JSON_UNQUOTE(JSON_EXTRACT(plan_content, '$.content'))
                ELSE plan_content
            END as planContent,
            is_template as isTemplate,
            created_at as createdAt,
            updated_at as updatedAt
        FROM ai_travel_plans
        WHERE plan_id = #{planId}
    </select>

    <!-- 사용자별 AI 여행 계획 목록 조회 (요약 정보) -->
    <select id="getUserTravelPlans" parameterType="String" resultType="com.tour.project.dto.TravelPlanSummaryDTO">
        SELECT 
            plan_id as planId,
            title,
            destination,
            start_date as startDate,
            end_date as endDate,
            duration,
            CASE 
                WHEN budget REGEXP '^[0-9]+$' THEN CAST(budget AS DECIMAL(10,2))
                ELSE NULL
            END as budget,
            max_participants as maxParticipants,
            created_at as createdAt,
            is_template as isTemplate
        FROM ai_travel_plans
        WHERE user_id = #{userId}
        ORDER BY created_at DESC
    </select>

    <!-- 사용자별 AI 여행 계획 목록 조회 (필터링) -->
    <select id="getUserTravelPlansWithFilter" parameterType="Map" resultType="com.tour.project.dto.TravelPlanSummaryDTO">
        SELECT 
            plan_id as planId,
            title,
            destination,
            duration,
            budget,
            created_at as createdAt,
            status,
            is_template as isTemplate,
            memo
        FROM travel_plans
        WHERE user_id = #{userId}
        <if test="status != null">
            AND status = #{status}
        </if>
        <if test="destination != null">
            AND destination LIKE CONCAT('%', #{destination}, '%')
        </if>
        ORDER BY created_at DESC
        <if test="limit != null">
            LIMIT #{limit}
        </if>
    </select>

    <!-- AI 여행 계획 수정 -->
    <update id="updateAiTravelPlan" parameterType="com.tour.project.dto.AiTravelPlanDTO">
        UPDATE travel_plans 
        SET 
            title = #{title},
            destination = #{destination},
            start_date = #{startDate},
            end_date = #{endDate},
            duration = #{duration},
            budget = #{budget},
            travel_style = #{travelStyle},
            plan_content = #{planContent},
            memo = #{memo},
            is_template = #{isTemplate},
            status = #{status},
            updated_at = CURRENT_TIMESTAMP
        WHERE plan_id = #{planId} AND user_id = #{userId}
    </update>

    <!-- AI 여행 계획 삭제 -->
    <delete id="deleteAiTravelPlan">
        DELETE FROM ai_travel_plans 
        WHERE plan_id = #{planId} AND user_id = #{userId}
    </delete>

    <!-- 계획 소유권 확인 -->
    <select id="isOwner" resultType="boolean">
        SELECT COUNT(*) > 0
        FROM ai_travel_plans
        WHERE plan_id = #{planId} AND user_id = #{userId}
    </select>

    <!-- 템플릿 계획 목록 조회 -->
    <select id="getTemplateList" parameterType="Map" resultType="com.tour.project.dto.TravelPlanSummaryDTO">
        SELECT 
            plan_id as planId,
            title,
            destination,
            duration,
            budget,
            created_at as createdAt,
            status,
            is_template as isTemplate,
            memo
        FROM travel_plans
        WHERE is_template = true
        AND status = 'completed'
        ORDER BY created_at DESC
        <if test="limit != null">
            LIMIT #{limit}
        </if>
    </select>

    <!-- 인기 계획 목록 조회 -->
    <select id="getPopularPlans" parameterType="Map" resultType="com.tour.project.dto.TravelPlanSummaryDTO">
        SELECT 
            tp.plan_id as planId,
            tp.title,
            tp.destination,
            tp.duration,
            tp.budget,
            tp.created_at as createdAt,
            tp.status,
            tp.is_template as isTemplate,
            tp.memo
        FROM travel_plans tp
        WHERE tp.status = 'completed'
        ORDER BY tp.created_at DESC
        <if test="limit != null">
            LIMIT #{limit}
        </if>
    </select>

    <!-- 사용자 계획 검색 -->
    <select id="searchUserPlans" parameterType="Map" resultType="com.tour.project.dto.TravelPlanSummaryDTO">
        SELECT DISTINCT
            tp.plan_id as planId,
            tp.title,
            tp.destination,
            tp.duration,
            tp.budget,
            tp.created_at as createdAt,
            tp.status,
            tp.is_template as isTemplate,
            tp.memo
        FROM travel_plans tp
        LEFT JOIN plan_tags pt ON tp.plan_id = pt.plan_id
        WHERE tp.user_id = #{userId}
        <if test="keyword != null">
            AND (tp.title LIKE CONCAT('%', #{keyword}, '%') 
                 OR tp.destination LIKE CONCAT('%', #{keyword}, '%')
                 OR tp.memo LIKE CONCAT('%', #{keyword}, '%'))
        </if>
        <if test="destination != null">
            AND tp.destination LIKE CONCAT('%', #{destination}, '%')
        </if>
        <if test="tags != null and tags.size() > 0">
            AND pt.tag_name IN
            <foreach item="tag" collection="tags" open="(" separator="," close=")">
                #{tag}
            </foreach>
        </if>
        ORDER BY tp.created_at DESC
    </select>

    <!-- 태그별 계획 검색 -->
    <select id="getPlansByTags" parameterType="Map" resultType="com.tour.project.dto.TravelPlanSummaryDTO">
        SELECT DISTINCT
            tp.plan_id as planId,
            tp.title,
            tp.destination,
            tp.duration,
            tp.budget,
            tp.created_at as createdAt,
            tp.status,
            tp.is_template as isTemplate,
            tp.memo
        FROM travel_plans tp
        INNER JOIN plan_tags pt ON tp.plan_id = pt.plan_id
        WHERE pt.tag_name IN
        <foreach item="tag" collection="tags" open="(" separator="," close=")">
            #{tag}
        </foreach>
        <if test="userId != null">
            AND tp.user_id = #{userId}
        </if>
        ORDER BY tp.created_at DESC
        <if test="limit != null">
            LIMIT #{limit}
        </if>
    </select>

</mapper>