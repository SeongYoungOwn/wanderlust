<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.tour.project.dao.BadgeDAO">
    
    <!-- 사용자의 모든 뱃지 조회 -->
    <select id="getUserBadges" resultType="com.tour.project.dto.BadgeDTO">
        SELECT 
            b.badge_id,
            b.badge_name,
            b.badge_description,
            b.badge_icon,
            b.badge_type,
            b.created_date,
            ub.earned_date
        FROM badges b
        INNER JOIN user_badges ub ON b.badge_id = ub.badge_id
        WHERE ub.user_id = #{userId}
        ORDER BY ub.earned_date DESC
    </select>
    
    <!-- 특정 뱃지 정보 조회 -->
    <select id="getBadgeById" resultType="com.tour.project.dto.BadgeDTO">
        SELECT 
            badge_id,
            badge_name,
            badge_description,
            badge_icon,
            badge_type,
            created_date
        FROM badges
        WHERE badge_id = #{badgeId}
    </select>
    
    <!-- 모든 뱃지 목록 조회 -->
    <select id="getAllBadges" resultType="com.tour.project.dto.BadgeDTO">
        SELECT 
            badge_id,
            badge_name,
            badge_description,
            badge_icon,
            badge_type,
            created_date
        FROM badges
        ORDER BY badge_type, badge_id
    </select>
    
    <!-- 사용자에게 뱃지 부여 -->
    <insert id="awardBadge">
        INSERT INTO user_badges (user_id, badge_id, earned_date)
        VALUES (#{userId}, #{badgeId}, NOW())
        ON DUPLICATE KEY UPDATE earned_date = earned_date
    </insert>
    
    <!-- 사용자가 특정 뱃지를 가지고 있는지 확인 -->
    <select id="hasUserBadge" resultType="boolean">
        SELECT COUNT(*) > 0
        FROM user_badges
        WHERE user_id = #{userId} AND badge_id = #{badgeId}
    </select>
    
    <!-- 뱃지 타입별 조회 -->
    <select id="getBadgesByType" resultType="com.tour.project.dto.BadgeDTO">
        SELECT 
            badge_id,
            badge_name,
            badge_description,
            badge_icon,
            badge_type,
            created_date
        FROM badges
        WHERE badge_type = #{badgeType}
        ORDER BY badge_id
    </select>
    
    <!-- 사용자 뱃지 개수 조회 -->
    <select id="getUserBadgeCount" resultType="int">
        SELECT COUNT(*)
        FROM user_badges
        WHERE user_id = #{userId}
    </select>
    
</mapper>