<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.tour.project.dao.MemberDAO">

    <insert id="insertMember" parameterType="com.tour.project.dto.MemberDTO">
        INSERT INTO member (user_id, user_password, user_name, user_email, nickname, gender, age, manner_temperature, user_regdate)
        VALUES (#{userId}, #{userPassword}, #{userName}, #{userEmail}, #{nickname}, #{gender}, #{age}, #{mannerTemperature}, NOW())
    </insert>

    <select id="getMember" parameterType="string" resultType="com.tour.project.dto.MemberDTO">
        SELECT user_id as userId, user_password as userPassword, user_name as userName,
               user_email as userEmail, user_mbti as userMbti, nickname, gender, age,
               manner_temperature as mannerTemperature, profile_image as profileImage, user_regdate as userRegdate,
               user_role as userRole, account_status as accountStatus, bio
        FROM member
        WHERE user_id = #{userId}
    </select>
    
    <select id="getMemberByEmail" parameterType="string" resultType="com.tour.project.dto.MemberDTO">
        SELECT user_id as userId, user_password as userPassword, user_name as userName,
               user_email as userEmail, user_mbti as userMbti, nickname, gender, age,
               manner_temperature as mannerTemperature, profile_image as profileImage, user_regdate as userRegdate,
               user_role as userRole, account_status as accountStatus, bio
        FROM member
        WHERE user_email = #{userEmail}
    </select>
    
    <select id="getMemberByName" parameterType="string" resultType="com.tour.project.dto.MemberDTO">
        SELECT user_id as userId, user_password as userPassword, user_name as userName,
               user_email as userEmail, user_mbti as userMbti, nickname, gender, age,
               manner_temperature as mannerTemperature, profile_image as profileImage, user_regdate as userRegdate,
               user_role as userRole, account_status as accountStatus, bio
        FROM member
        WHERE user_name = #{userName}
    </select>
    
    <update id="updateMember" parameterType="com.tour.project.dto.MemberDTO">
        UPDATE member 
        SET user_password = #{userPassword}, user_name = #{userName}, 
            user_email = #{userEmail}, nickname = #{nickname}, gender = #{gender}, age = #{age}
        WHERE user_id = #{userId}
    </update>
    
    <delete id="deleteMember" parameterType="string">
        DELETE FROM member WHERE user_id = #{userId}
    </delete>
    
    <select id="getTime" resultType="string">
        SELECT NOW()
    </select>
    
    <!-- ID로 멤버 조회 -->
    <select id="getMemberById" parameterType="string" resultType="com.tour.project.dto.MemberDTO">
        SELECT user_id as userId, user_password as userPassword, user_name as userName,
               user_email as userEmail, user_mbti as userMbti, user_regdate as userRegdate,
               nickname, gender, age, manner_temperature as mannerTemperature, profile_image as profileImage, bio,
               user_role as userRole, account_status as accountStatus
        FROM member
        WHERE user_id = #{userId}
    </select>
    
    <!-- MBTI로 멤버들 조회 -->
    <select id="getMembersByMbti" parameterType="string" resultType="com.tour.project.dto.MemberDTO">
        SELECT m.user_id as userId, m.user_password as userPassword, m.user_name as userName, 
               m.user_email as userEmail, m.user_mbti as userMbti, m.user_regdate as userRegdate,
               m.nickname, m.gender, m.age, m.manner_temperature as mannerTemperature, m.profile_image as profileImage
        FROM member m
        INNER JOIN user_travel_mbti utm ON m.user_id = utm.user_id
        WHERE utm.mbti_type = #{mbtiType}
        AND utm.test_date = (
            SELECT MAX(test_date) 
            FROM user_travel_mbti 
            WHERE user_id = m.user_id
        )
        ORDER BY m.user_regdate DESC
    </select>
    
    <!-- 아이디 중복 확인 -->
    <select id="isUserIdExists" parameterType="string" resultType="boolean">
        SELECT COUNT(*) > 0 FROM member WHERE user_id = #{userId}
    </select>
    
    <!-- 닉네임 중복 확인 -->
    <select id="isNicknameExists" parameterType="string" resultType="boolean">
        SELECT COUNT(*) > 0 FROM member WHERE nickname = #{nickname}
    </select>
    
    <!-- 닉네임으로 멤버 조회 -->
    <select id="getMemberByNickname" parameterType="string" resultType="com.tour.project.dto.MemberDTO">
        SELECT user_id as userId, user_password as userPassword, user_name as userName, 
               user_email as userEmail, user_mbti as userMbti, nickname, gender, age,
               manner_temperature as mannerTemperature, profile_image as profileImage, user_regdate as userRegdate
        FROM member
        WHERE nickname = #{nickname}
    </select>
    
    <!-- 프로필 이미지 업데이트 -->
    <update id="updateProfileImage" parameterType="map">
        UPDATE member 
        SET profile_image = #{profileImage}
        WHERE user_id = #{userId}
    </update>
    
    <!-- 모든 멤버 조회 -->
    <select id="getAllMembers" resultType="com.tour.project.dto.MemberDTO">
        SELECT user_id as userId, user_password as userPassword, user_name as userName, 
               user_email as userEmail, user_mbti as userMbti, nickname, gender, age,
               manner_temperature as mannerTemperature, profile_image as profileImage, 
               user_regdate as userRegdate, user_role as userRole, account_status as accountStatus
        FROM member
        ORDER BY user_regdate DESC
    </select>
    
    <!-- 전체 활성 사용자 수 조회 -->
    <select id="getActiveMemberCount" resultType="int">
        SELECT COUNT(*) 
        FROM member 
        WHERE account_status IS NULL OR account_status != 'DELETED'
    </select>
    
    <!-- 최근 가입한 사용자들 조회 (프로필 이미지가 있는 사용자 우선, 최대 3명) -->
    <select id="getRecentMembersWithProfile" parameterType="int" resultType="com.tour.project.dto.MemberDTO">
        SELECT user_id as userId, user_name as userName, nickname, 
               profile_image as profileImage, user_regdate as userRegdate
        FROM member 
        WHERE (account_status IS NULL OR account_status != 'DELETED')
        ORDER BY 
            CASE WHEN profile_image IS NOT NULL AND profile_image != '' THEN 0 ELSE 1 END,
            user_regdate DESC
        LIMIT #{limit}
    </select>
    
    <!-- 닉네임 자동완성 검색 (현재 사용자 제외) -->
    <select id="searchNicknamesByQuery" parameterType="map" resultType="com.tour.project.dto.MemberDTO">
        SELECT user_id as userId, user_name as userName, nickname
        FROM member 
        WHERE nickname LIKE CONCAT(#{query}, '%') 
        AND user_id != #{currentUserId}
        AND nickname IS NOT NULL 
        AND nickname != ''
        AND (account_status IS NULL OR account_status != 'DELETED')
        ORDER BY nickname ASC
        LIMIT 10
    </select>

    <!-- 자기소개 업데이트 -->
    <update id="updateBio">
        UPDATE member
        SET bio = #{bio}
        WHERE user_id = #{userId}
    </update>

    <!-- 사용자 활동 통계 조회 -->
    <select id="getUserActivityStats" resultType="map">
        SELECT
            (SELECT COUNT(*) FROM board WHERE user_id = #{userId}) as postCount,
            (SELECT COUNT(*) FROM board_comment WHERE user_id = #{userId}) as commentCount,
            (SELECT COUNT(*) FROM report WHERE reported_user_id = #{userId}) as reportCount
    </select>

    <!-- 모든 사용자의 활동 통계 조회 -->
    <select id="getAllUsersActivityStats" resultType="map">
        SELECT
            m.user_id,
            (SELECT COUNT(*) FROM board WHERE board_writer = m.user_id) as postCount,
            0 as commentCount,
            0 as reportCount
        FROM member m
    </select>

    <!-- 이메일로 회원 찾기 -->
    <select id="findByEmail" parameterType="string" resultType="com.tour.project.dto.MemberDTO">
        SELECT user_id as userId, user_password as userPassword, user_name as userName,
               user_email as userEmail, user_mbti as userMbti, nickname, gender, age,
               manner_temperature as mannerTemperature, profile_image as profileImage,
               user_regdate as userRegdate, user_role as userRole, account_status as accountStatus, bio
        FROM member
        WHERE user_email = #{email}
    </select>

</mapper>