stages:
  - build
  - deploy

variables:
  MAVEN_OPTS: "-Dmaven.repo.local=$CI_PROJECT_DIR/.m2/repository"
  MAVEN_CLI_OPTS: "--batch-mode --errors --fail-at-end --show-version"
  DEPLOY_DIR: /data1/docker/wanderlust

# Cache Maven dependencies
cache:
  paths:
    - .m2/repository

# Build stage: Validate compilation only
build:
  stage: build
  image: maven:3.9-eclipse-temurin-17
  tags:
    - docker
  script:
    - echo "Validating Wanderlust compilation..."
    - mvn $MAVEN_CLI_OPTS clean compile
    - echo "Compilation validation completed successfully"
  only:
    - main
    - develop

# Deploy to production (Tomcat auto-deployment)
deploy:production:
  stage: deploy
  image: alpine:latest
  tags:
    - docker
  before_script:
    - apk add --no-cache curl openjdk17 maven git
  script:
    # Clone and build
    - echo "Building Wanderlust application..."
    - rm -rf /tmp/wanderlust-build
    - git clone --single-branch --branch main https://gitlab-ci-token:${CI_JOB_TOKEN}@gitlab.ibetter.kr/wanderlust/wanderlust_new.git /tmp/wanderlust-build
    - cd /tmp/wanderlust-build
    - mvn clean package -DskipTests

    # Prepare deployment
    - echo "Preparing deployment files..."
    - mkdir -p $DEPLOY_DIR/webapps
    - cp docker-compose.yml $DEPLOY_DIR/
    - |
      cat > $DEPLOY_DIR/.env << EOF
      DB_USERNAME=${DB_USERNAME}
      DB_PASSWORD=${DB_PASSWORD}
      CLAUDE_API_KEY=${CLAUDE_API_KEY}
      EOF
    - chmod 600 $DEPLOY_DIR/.env

    # Deploy WAR file (Tomcat auto-deployment)
    - echo "Deploying WAR file..."
    - cp target/*.war $DEPLOY_DIR/webapps/ROOT.war
    - echo "✅ WAR 파일 배포 완료 - Tomcat이 자동으로 재배포합니다"

    # Database migration (if migration script exists)
    - echo "Checking for database migrations..."
    - |
      if [ -f /tmp/wanderlust-build/src/main/resources/sql/migration_add_guides.sql ]; then
        echo "Running database migration..."
        apk add --no-cache mariadb-client
        mysql -h mariadb-11.4.5 -u ${DB_USERNAME} -p${DB_PASSWORD} wanderlust < /tmp/wanderlust-build/src/main/resources/sql/migration_add_guides.sql || echo "⚠️ Migration already applied or failed"
        echo "✅ Database migration completed"
      else
        echo "No migration script found, skipping..."
      fi

    # Force container restart to ensure clean deployment
    - echo "Restarting application container..."
    - cd $DEPLOY_DIR
    - apk add --no-cache docker-compose
    - docker-compose restart wanderlust-app || echo "⚠️ Container restart failed - continuing anyway"
    - echo "✅ 애플리케이션 재시작 완료"

  after_script:
    # Wait for Tomcat to redeploy
    - echo "Tomcat auto-deployment 대기 중..."
    - sleep 20
    - echo "Performing health check..."
    - curl -f https://wanderlust.ibetter.kr/ || echo "⚠️ Health check failed - Tomcat 재배포 진행 중일 수 있습니다"
  environment:
    name: production
    url: https://wanderlust.ibetter.kr
  only:
    - main
  when: on_success

